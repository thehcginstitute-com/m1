<?php
# 2024-09-01 Dmitrii Fediuk https://upwork.com/fl/mage2pro
# 1) "Improve the «Yaay! Recovered by Mailchimp's campaign» block of the backend order screen":
# https://github.com/thehcginstitute-com/m1/issues/668
# 2) "Refactor `app/design/adminhtml/default/default/template/sales/order/view/info.phtml`":
# https://github.com/thehcginstitute-com/m1/issues/669
use Mage_Sales_Model_Order as O;
$o = $this->getOrder(); /** @var O $o */
?>
<script type="text/javascript">
	var ORDER_ID = <?= $o->getId(); ?>;
</script>
<?php
$orderAdminDate = $this->formatDate($o->getCreatedAtDate(), 'medium', true);
$orderStoreDate = $this->formatDate($o->getCreatedAtStoreDate(), 'medium', true);
$invoice_id = df_request('invoice_id');
$shipment_id = df_request('shipment_id');
$creditmemo_id = df_request('creditmemo_id');
$isAllowEdit = Mage::getModel('iwd_ordermanager/order_edit')->checkOrderStatusForUpdate($o);
$helper = Mage::helper('iwd_ordermanager');
?>
<div class="box-left order-info">
	<!--Order Information-->
	<div class="entry-edit">
		<?php if ($o->getEmailSent()):
			$_email = Mage::helper('sales')->__('the order confirmation email was sent');
		else:
			$_email = Mage::helper('sales')->__('the order confirmation email is not sent');
		endif ?>
		<div class="entry-edit-head order-edit">
			<?php if ($this->getNoUseOrderLink()): ?>
				<h4 class="icon-head head-account"><?= Mage::helper('sales')->__('Order #%s', $o->getRealOrderId()) ?>
					(<?= $_email ?>)</h4>
			<?php else: ?>
				<a href="<?= $this->getViewUrl($o->getId()) ?>"><?= Mage::helper('sales')->__('Order #%s', $o->getRealOrderId()) ?></a>
				<strong>(<?= $_email ?>)</strong>
			<?php endif ?>

			<div class="tools" style="float:right">
				<?php $isAllow = Mage::getSingleton('admin/session')->isAllowed('iwd_ordermanager/order/actions/edit_order_information'); ?>
				<?php if ($isAllow) : ?>
					<?php if ($isAllowEdit) : ?>
						<a id="order_information_edit_<?= $o->getEntityId(); ?>"
						   class="order_information_edit" href="#"
						   <?php if(!empty($invoice_id)): ?>data-invoice-id="<?= $invoice_id; ?>"<?php endif ?>
						   <?php if(!empty($shipment_id)): ?>data-shipping-id="<?= $shipment_id; ?>"<?php endif ?>
						   <?php if(!empty($creditmemo_id)): ?>data-creditmemo-id="<?= $creditmemo_id; ?>"<?php endif ?>
						   title="<?= Mage::helper('sales')->__('Edit order information'); ?>">
							<?= Mage::helper('sales')->__('Edit'); ?>
						</a>
					<?php else : ?>
						<a href="#"
						   onclick="alert('<?= $helper->__("Sorry, You can not update order information for order with this status. Check configuration by module IWD_OrderManager.") ?>'); return false;"
						   title="<?= $helper->__("You can not edit order information!"); ?>">
							<?= Mage::helper('sales')->__("Edit"); ?>
						</a>
					<?php endif ?>
				<?php endif ?>
			</div>
		</div>
		<div class="fieldset">
			<table cellspacing="0" class="form-list" id="order_information">
				<tr>
					<td class="label"><label><?= Mage::helper('sales')->__('Order Date') ?></label></td>
					<td class="value"><strong><?= $orderAdminDate ?></strong></td>
				</tr>
				<?php if ($orderAdminDate != $orderStoreDate): ?>
					<tr>
						<td class="label">
							<label><?= Mage::helper('sales')->__('Order Date (%s)', $o->getCreatedAtStoreDate()->getTimezone()) ?></label>
						</td>
						<td class="value"><strong><?= $orderStoreDate ?></strong></td>
					</tr>
				<?php endif ?>
				<tr>
					<td class="label"><label><?= Mage::helper('sales')->__('Order Status') ?></label></td>
					<td class="value"><strong><span
									id="order_status"><?= $o->getStatusLabel() ?></span></strong></td>
				</tr>
				<tr>
					<td class="label"><label><?= Mage::helper('sales')->__('Purchased From') ?></label></td>
					<td class="value"><strong><?= $this->getOrderStoreName() ?></strong></td>
				</tr>
				<?php if ($o->getRelationChildId()): ?>
					<tr>
						<td class="label">
							<label><?= Mage::helper('sales')->__('Link to the New Order') ?></label></td>
						<td class="value"><a href="<?= $this->getViewUrl($o->getRelationChildId()) ?>">
								<?= $o->getRelationChildRealId() ?>
							</a></td>
					</tr>
				<?php endif ?>
				<?php if ($o->getRelationParentId()): ?>
					<tr>
						<td class="label">
							<label><?= Mage::helper('sales')->__('Link to the Previous Order') ?></label></td>
						<td class="value"><a href="<?= $this->getViewUrl($o->getRelationParentId()) ?>">
								<?= $o->getRelationParentRealId() ?>
							</a></td>
					</tr>
				<?php endif ?>
				<?php if ($o->getRemoteIp()): ?>
					<tr>
						<td class="label"><label><?= Mage::helper('sales')->__('Placed from IP') ?></label></td>
						<td class="value"><strong><?= $o->getRemoteIp();
								echo ($o->getXForwardedFor()) ? ' (' . $this->escapeHtml($o->getXForwardedFor()) . ')' : ''; ?></strong>
						</td>
					</tr>
				<?php endif ?>
				<?php
					/**
					 * 2024-09-01 Dmitrii Fediuk https://upwork.com/fl/mage2pro
					 * 1) "Refactor the `Ebizmarts_MailChimp` module": https://github.com/cabinetsbay/site/issues/524
					 * 2) "Improve the «Yaay! Recovered by Mailchimp's campaign» block of the backend order screen":
					 * https://github.com/thehcginstitute-com/m1/issues/668
					 */
					if (hcg_mc_h()->isEcomSyncDataEnabled($o->getStoreId())) {
						$cid = $o['mailchimp_campaign_id']; /** @var ?string $cid */
						if ($cid) {
							$cn = hcg_mc_h()->getMailChimpCampaignNameById($cid, $o->getStoreId());
						}
						echo df_tag('tr', [], [
							df_tag('td', 'label', 'Mailchimp Campaign')
							,df_tag('td', 'value', "<b>$cn</b> ($cid)")
						]);
					}
				?>
				<?php if ($o->getGlobalCurrencyCode() != $o->getBaseCurrencyCode()): ?>
					<tr>
						<td class="label">
							<label><?= Mage::helper('sales')->__('%s / %s rate:', $o->getGlobalCurrencyCode(), $o->getBaseCurrencyCode()) ?></label>
						</td>
						<td class="value"><strong><?= $o->getBaseToGlobalRate() ?></strong></td>
					</tr>
				<?php endif ?>
				<?php if ($o->getBaseCurrencyCode() != $o->getOrderCurrencyCode()): ?>
					<tr>
						<td class="label">
							<label><?= Mage::helper('sales')->__('%s / %s rate:', $o->getOrderCurrencyCode(), $o->getBaseCurrencyCode()) ?></label>
						</td>
						<td class="value"><strong><?= $o->getBaseToOrderRate() ?></strong></td>
					</tr>
				<?php endif ?>

				<?php if (Mage::helper('iwd_ordermanager')->isAllowHideOrders() && $o->getIwdOmStatus() == 1): ?>
					<tr>
						<td class="label">
							<label><strong style="color:#e22b00!important"><?= Mage::helper('sales')->__('Hide On Front') ?></strong></label>
						</td>
						<td class="value">
							<strong style="color:#e22b00!important">
								<?= Mage::helper('sales')->__('This order is hidden in customer account on front') ?><br>
								<a id="order_information_edit_<?= $o->getEntityId(); ?>"
								   class="order_information_edit" href="#"
								   <?php if(!empty($invoice_id)): ?>data-invoice-id="<?= $invoice_id; ?>"<?php endif ?>
								   <?php if(!empty($shipment_id)): ?>data-shipping-id="<?= $shipment_id; ?>"<?php endif ?>
								   <?php if(!empty($creditmemo_id)): ?>data-creditmemo-id="<?= $creditmemo_id; ?>"<?php endif ?>
								   title="<?= Mage::helper('sales')->__('Enable this order '); ?>">
									<?= Mage::helper('sales')->__('Enable this order '); ?></a>
							</strong>
						</td>
					</tr>
				<?php endif ?>
			</table>
		</div>
	</div>
</div>
<div class="box-right">
	<!--Account Information-->
	<div class="entry-edit">

		<div class="entry-edit-head order-account">
			<h4 class="icon-head head-account"><?= Mage::helper('sales')->__('Account Information') ?></h4>

			<div class="tools" style="float:right">
				<?php $isAllow = Mage::getSingleton('admin/session')->isAllowed('iwd_ordermanager/order/actions/edit_account_information'); ?>
				<?php if ($isAllow): ?>
					<?php if ($isAllowEdit) : ?>
						<a id="account_information_edit_<?= $o->getEntityId(); ?>"
						   class="account_information_edit" href="#"
						   title="<?= Mage::helper('sales')->__('Edit account information for order only'); ?>">
							<?= Mage::helper('sales')->__('Edit'); ?>
						</a>
					<?php else : ?>
						<a href="#"
						   onclick="alert('<?= $helper->__("Sorry, You can not update account information for order with this status. Check configuration by module IWD_OrderManager.") ?>'); return false;"
						   title="<?= $helper->__("You can not edit account information!"); ?>">
							<?= Mage::helper('sales')->__("Edit"); ?>
						</a>
					<?php endif ?>
				<?php endif ?>
			</div>
		</div>
		<div class="fieldset">
			<div class="hor-scroll">
				<div class="hor-scroll" id="account_information_<?= $o->getEntityId(); ?>">
					<table cellspacing="0" class="form-list">
						<tr>
							<td class="label"><label><?= Mage::helper('sales')->__('Customer Name') ?></label></td>
							<td class="value">
								<?php if ($_customerUrl = $this->getCustomerViewUrl()) : ?>
									<a href="<?= $_customerUrl ?>"
									   target="_blank"><strong><?= $this->htmlEscape($o->getCustomerName()) ?></strong></a>
								<?php else: ?>
									<strong><?= $this->htmlEscape($o->getCustomerName()) ?></strong>
								<?php endif ?>
							</td>
						</tr>
						<tr>
							<td class="label"><label><?= Mage::helper('sales')->__('Email') ?></label></td>
							<td class="value"><a
										href="mailto:<?= $o->getCustomerEmail() ?>"><strong><?= $o->getCustomerEmail() ?></strong></a>
							</td>
						</tr>
						<?php if ($_groupName = $this->getCustomerGroupName()) : ?>
							<tr>
								<td class="label"><label><?= Mage::helper('sales')->__('Customer Group') ?></label>
								</td>
								<td class="value"><strong><?= $_groupName ?></strong></td>
							</tr>
						<?php endif ?>
						<?php foreach ($this->getCustomerAccountData() as $data): ?>
							<tr>
								<td class="label"><label><?= $data['label'] ?></label></td>
								<td class="value"><strong><?= $data['value'] ?></strong></td>
							</tr>
						<?php endforeach;
							# 2024-01-26 Dmitrii Fediuk https://upwork.com/fl/mage2pro
							# "The template `opcsignature/sales/order/view/info.phtml`
							# of `IWD_OnepageCheckoutSignature_Block_Sales_Order_View_Info`
							# conflicts with the template `customfield/sales/order/view/info.phtml` of `Webkul_CustomField`,
							# the template `iwd/ordermanager/order/view/info.phtml` of `IWD_OrderManager`,
							# and the template `iwd/orderflags/order/view/info.phtml` of `IWD_OrderFlags`,
							# because they are all override the template `sales/order/view/info.phtml`
							# of `Mage_Adminhtml_Block_Sales_Order_View_Info`":
							# https://github.com/thehcginstitute-com/m1/issues/327
							$p = 'hcg/sales/order/view/info/'; /** @var string $p */
							echo df_render_simple("{$p}IWD_OnepageCheckoutSignature.phtml", [], ['_order' => $o]);
							# 2024-02-18 Dmitrii Fediuk https://upwork.com/fl/mage2pro
							# "Delete the unused `Webkul_CustomField` module":
							# https://github.com/thehcginstitute-com/m1/issues/382
						?>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="clear"></div>

<div class="box-left">
	<!--Billing Address-->
	<div class="entry-edit">
		<div class="hor-scroll">
			<div class="entry-edit-head billing-address">
				<h4 class="icon-head head-billing-address"><?= Mage::helper('sales')->__('Billing Address') ?></h4>

				<div class="tools" style="float:right">
					<?php $isAllow = Mage::getModel('iwd_ordermanager/address')->isAllowEditAddress(); ?>
					<?php if ($isAllow): ?>
						<?php if ($isAllowEdit) : ?>
							<a id="billing_address_edit_<?= $o->getBillingAddress()->getId() ?>"
							   class="order_address_edit" href="#"
							   title="<?= Mage::helper('sales')->__('Edit billing address for order only'); ?>">
								<?= Mage::helper('sales')->__('Edit'); ?>
							</a>
						<?php else : ?>
							<a href="#"
							   onclick="alert('<?= $helper->__("Sorry, You can not update billing address for order with this status. Check configuration by module IWD_OrderManager.") ?>'); return false;"
							   title="<?= $helper->__("You can not edit billing address!"); ?>">
								<?= Mage::helper('sales')->__("Edit"); ?>
							</a>
						<?php endif ?>
					<?php endif ?>
				</div>
			</div>
			<fieldset>
				<address id="order_address_<?= $o->getBillingAddress()->getId() ?>"><?= $o->getBillingAddress()->getFormated(true) ?></address>
			</fieldset>
		</div>
	</div>
</div>
<?php if (!$this->getOrder()->getIsVirtual()): ?>
	<div class="box-right">
		<!--Shipping Address-->
		<div class="hor-scroll">
			<div class="entry-edit">
				<div class="entry-edit-head order-shipping">
					<h4 class="icon-head head-shipping-address"><?= Mage::helper('sales')->__('Shipping Address') ?></h4>
					<div class="tools" style="float:right">
						<?php if ($isAllow): ?>
							<?php if ($isAllowEdit) : ?>
								<a id="shipping_address_edit_<?= $o->getShippingAddress()->getId() ?>"
								   class="order_address_edit" href="#"
								   title="<?= Mage::helper('sales')->__('Edit shipping address for order only') ?>">
									<?= Mage::helper('sales')->__('Edit'); ?>
								</a>
							<?php else : ?>
								<a href="#"
								   onclick="alert('<?= $helper->__("Sorry, You can not update shipping address for order with this status. Check configuration by module IWD_OrderManager.") ?>'); return false;"
								   title="<?= $helper->__("You can not edit shipping address!"); ?>">
									<?= Mage::helper('sales')->__("Edit"); ?>
								</a>
							<?php endif ?>
						<?php endif ?>
					</div>
				</div>
				<fieldset>
					<address id="order_address_<?= $o->getShippingAddress()->getId() ?>"><?= $this->maliciousCodeFilter($o->getShippingAddress()->getFormated(true)) ?></address>
				</fieldset>
			</div>
		</div>
	</div>
	<div class="clear"></div>
<?php endif ?>